<!-- index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>YouTube 재생목록 자동 추가기</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; max-width: 720px; margin: auto; padding: 20px; }
    input, button, textarea { width: 100%; margin: 8px 0; padding: 8px; box-sizing: border-box; }
    textarea { height: 120px; }
    ul { list-style: none; padding: 0; }
    li { margin: 6px 0; }
  </style>
</head>
<body>
  <h2>YouTube 영상 오래된 순으로 불러오기 & 재생목록 추가</h2>

  <input id="channelId" placeholder="채널 ID 입력 (예: UC_x5XG1OV2P6uZZ5FSM9Ttw)" />
  <button onclick="loadVideos()">영상 불러오기</button>
  <ul id="videoList"></ul>
  <button id="loadMoreBtn" onclick="loadMoreVideos()" style="display:none;">더 보기</button>
  <textarea id="videoUrls" readonly></textarea>

  <hr>

  <button onclick="authenticate()">Google 로그인</button>
  <input id="playlistTitle" placeholder="새 재생목록 이름 입력" />
  <button onclick="createPlaylistAndAddVideos()">재생목록 생성 + 영상 추가</button>

  <script>
    const apiKey = "AIzaSyC29ZNxxQ4sVqokPzZrVxLCYsOmToPDwUs";
    const clientId = "938294569584-amj2vuae1ohla2kpotgu21c6i1u8snmp.apps.googleusercontent.com";
    const scopes = "https://www.googleapis.com/auth/youtube";
    let accessToken = null;
    let videoIds = [];
    let displayedCount = 0;
    const batchSize = 10;
    let tokenClient;

    window.onload = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId,
        scope: scopes,
        callback: (tokenResponse) => {
          if (tokenResponse && tokenResponse.access_token) {
            accessToken = tokenResponse.access_token;
            gapi.load("client", async () => {
              await gapi.client.init({ apiKey });
              await gapi.client.load("youtube", "v3");
              alert("인증 완료!");
            });
          } else {
            alert("인증 실패");
          }
        }
      });
    }

    function authenticate() {
      tokenClient.requestAccessToken();
    }

    async function loadVideos() {
      const channelId = document.getElementById("channelId").value.trim();
      const videoList = document.getElementById("videoList");
      const videoUrls = document.getElementById("videoUrls");
      const loadMoreBtn = document.getElementById("loadMoreBtn");
      videoList.innerHTML = '<li>불러오는 중...</li>';
      videoUrls.value = '';
      loadMoreBtn.style.display = 'none';
      displayedCount = 0;

      try {
        const playlistId = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${channelId}&key=${apiKey}`)
          .then(r => r.json())
          .then(d => d.items[0].contentDetails.relatedPlaylists.uploads);

        let videos = [], next = '';
        do {
          const res = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&pageToken=${next}&key=${apiKey}`)
            .then(r => r.json());
          videos = videos.concat(res.items);
          next = res.nextPageToken;
        } while (next);

        videos.reverse();
        videoIds = videos.map(v => v.snippet.resourceId.videoId);

        videoList.innerHTML = '';
        showNextBatch();
        videoUrls.value = videoIds.map(id => `https://www.youtube.com/watch?v=${id}`).join('\n');
        if (videoIds.length > batchSize) loadMoreBtn.style.display = 'block';
      } catch (e) {
        alert("영상 불러오기 실패: " + e.message);
      }
    }

    function showNextBatch() {
      const videoList = document.getElementById("videoList");
      const nextBatch = videoIds.slice(displayedCount, displayedCount + batchSize);
      for (const id of nextBatch) {
        const url = `https://www.youtube.com/watch?v=${id}`;
        const li = document.createElement('li');
        li.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
        videoList.appendChild(li);
      }
      displayedCount += batchSize;
      if (displayedCount >= videoIds.length) {
        document.getElementById("loadMoreBtn").style.display = 'none';
      }
    }

    function loadMoreVideos() {
      showNextBatch();
    }

    async function createPlaylistAndAddVideos() {
      const title = document.getElementById("playlistTitle").value.trim();
      if (!accessToken) {
        alert("Google 로그인이 필요합니다.");
        return;
      }

      try {
        const playlistRes = await gapi.client.youtube.playlists.insert({
          part: "snippet,status",
          resource: {
            snippet: { title: title },
            status: { privacyStatus: "private" }
          }
        });
        const playlistId = playlistRes.result.id;

        for (const videoId of videoIds) {
          await gapi.client.youtube.playlistItems.insert({
            part: "snippet",
            resource: {
              snippet: {
                playlistId: playlistId,
                resourceId: {
                  kind: "youtube#video",
                  videoId: videoId
                }
              }
            }
          });
        }
        alert("재생목록이 생성되고 영상이 추가되었습니다!");
      } catch (e) {
        alert("재생목록 추가 실패: " + e.message);
      }
    }
  </script>
</body>
</html>
